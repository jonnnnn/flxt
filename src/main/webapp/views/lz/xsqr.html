<script src="/js/jquery-1.8.3.min.js"></script>
<div class="layui-fluid">
  <div class="layui-row">
    <div class="layui-col-xs12">
      <div class="layui-card">
        <div class="layui-card-body">
          <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>销售确认</legend>
          </fieldset>

          <form class="layui-form" id="xsqrsum" action="#" onsubmit="return false">
            <div class="layui-form-item" id="yxsid">

                <div class="layui-inline">
                <label class="layui-form-label">客户编码</label>
                <div class="layui-input-inline">
                  <input type="text" name="custno" id="custnoid"  readonly autocomplete="off"  class="layui-input">
              </div>
                </div>
                    <div class="layui-inline">
                <label class="layui-form-label">客户名称</label>
                <div class="layui-input-inline">
                    <input type="text" name="custname" id="custnameid" readonly   autocomplete="off" class="layui-input">
                </div>
                    </div>
                <div class="layui-inline">
                    <label class="layui-form-label">客户地址</label>
                    <div class="layui-input-inline">
                        <input type="tel" name="custadd" id="custaddid"  autocomplete="off" readonly class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">单据备注</label>
                    <div class="layui-input-inline">
                        <input type="tel" name="note" id="noteid"  autocomplete="off"  class="layui-input">
                    </div>
                </div>
            </div>
              <input type="hidden" name="yxsbillid" id="billidid">
          </form>
              <form class="layui-form" action="#" id="xsqrdet" onsubmit="return false">
              <ul id="lzul">
                  <li id="prod1">
              <div class="layui-form-item" >
                  <div class="layui-inline">
                      <label class="layui-form-label">商品编码</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="prodno" id="prodnoid"  readonly autocomplete="off" class="layui-input"></span>
                      </div>
                  </div>
                  <div class="layui-inline" >
                      <label class="layui-form-label" >商品名称</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="prodname" id="prodnameid" readonly autocomplete="off"  readonly class="layui-input"></span>
                      </div>
                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">规格</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="prodspecification" readonly id="prodspecificationid"  autocomplete="off" class="layui-input"></span>
                      </div>
                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">包装单位</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="packageunit" id="packageunitid" readonly autocomplete="off" class="layui-input"></span>
                      </div>
                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">生产厂家</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="manufacture" id="manufactureid" readonly  autocomplete="off" class="layui-input"></span>
                      </div>
                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">批准文号</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="approvalno" id="approvalnoid" readonly  autocomplete="off" class="layui-input"></span>
                      </div>
                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">灭菌方式</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="sterilization"   autocomplete="off" class="layui-input"></span>
                      </div>
                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">数量</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="quantity"  autocomplete="off" class="layui-input"></span>
                      </div>
                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">价格</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="amount"  autocomplete="off" class="layui-input"></span>
                      </div>
                  </div>
                  <div class="layui-inline">
                      <label class="layui-form-label">明细备注</label>
                      <div class="layui-input-inline">
                          <span><input type="text" name="note"   autocomplete="off" class="layui-input"></span>
                      </div>
                  </div>
                  <!--<button class="layui-btn" onclick="deldet(this)">删除</button>-->
              </div>
                  </li>
              </ul>
              </form>
            <div class="layui-form-item">
              <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="demo1_hash">立即提交</button>
               <!-- <button type="reset" class="layui-btn layui-btn-primary">重置</button>-->
              </div>
            </div>

        </div>
      </div>
    </div>
  </div>
</div>
<script>
  layui.use(['form', 'layedit', 'laydate','jquery'], function() {
    var
      $ = layui.jquery,
      form = layui.form,
      layer = layui.layer,
      layedit = layui.layedit,
      laydate = layui.laydate;
    form.render();
      $.fn.serializeObject = function()
      {
          var o = {};
          var a = this.serializeArray();
          $.each(a, function() {
              if (o[this.name]) {
                  if (!o[this.name].push) {
                      o[this.name] = [o[this.name]];
                  }
                  o[this.name].push(this.value || '');
              } else {
                  o[this.name] = this.value || '';
              }
          });
          return o;
      };

      $("#yxsid").dblclick(function () {
          layer.open({
              type: 2,
              title: '选择单据',
              shadeClose: true,
              shade: 0.8,
              /*  btn:['提交','关闭'],*/
              area: ['60%', '90%'],//宽 高
              content: 'views/lz/selectyxs.html',
              success:function (layero,index ) {

              },end:function (index,layero) {
                  $.post('getOneYxsdet',{billid:$("#billidid").val()}, function (res) {
                      for(var i = 0;i<res.count-1;i++){
                          adddet();
                      }
                      $("#lzul").find("li").each(function(m){
                          $(this).find("span").each(function(n){
                              switch (n) {
                                  case 0: $(this).children("input").val(res.data[m].prodno);break;
                                  case 1: $(this).children("input").val(res.data[m].prodname);break;
                                  case 2: $(this).children("input").val(res.data[m].prodspecification);break;
                                  case 3: $(this).children("input").val(res.data[m].packageunit);break;
                                  case 4: $(this).children("input").val(res.data[m].manufacture);break;
                                  case 5: $(this).children("input").val(res.data[m].approvalno);break;
                                  case 6: $(this).children("input").val(res.data[m].sterilization);break;
                                  case 7: $(this).children("input").val(res.data[m].quantity);break;
                                  case 8: $(this).children("input").val(res.data[m].amount);break;
                                  case 9: $(this).children("input").val(res.data[m].note);break;
                              }
                          });
                      });
                  },'json');
              }
          });
      });


    //监听提交
    form.on('submit(demo1_hash)', function(data) {
        var xsqrjson = []; //全局变量
        var para = $('#xsqrsum').serializeObject() ;
        xsqrjson.push(para);
        $("#lzul").find("li").each(function(m){  //遍历每个li，当前有两个li
            var recieverAttributes = [];
            $(this).find("span").each(function(n){  //遍历每个li下的span，而每个li下有三个span
                recieverAttributes[n] = $(this).children("input").val();  //找到每个span下存放着数据的input框，并获取值存放到数组中
            });
            var recieverObj = {
                prodno:recieverAttributes[0],
                prodname:recieverAttributes[1],
                prodspecification:recieverAttributes[2],
                packageunit:recieverAttributes[3],
                manufacture:recieverAttributes[4],
                approvalno:recieverAttributes[5],
                sterilization:recieverAttributes[6],
                quantity:recieverAttributes[7],
                amount:recieverAttributes[8],
                note:recieverAttributes[9]
            };
            xsqrjson.push(recieverObj);
        });

        /*---------------------------------------数据验证--------------------------------------*/
        if(xsqrjson[0].custname.trim() == ""){
            layer.msg("请填写客户信息！");
            return false;
        }
        var falgamount = [] ;
        var falgquantity = [] ;
        for (var n = 1;n < xsqrjson.length;n++){
            if(xsqrjson[n].prodno.trim()==""){
                layer.msg("请选择商品！");
                return false;
            }
            if (xsqrjson[n].amount.trim() == ""){
                falgamount.push(n)
            }
            if (xsqrjson[n].quantity.trim() == ""){
                falgquantity.push(n)
            }
        }
        if (falgamount.length!=0&&falgquantity.length!=0){
            layer.msg("请填写第"+falgquantity+"个商品的数量 和 第"+falgamount+"个商品的价格！");
            return false;
        } else if(falgamount.length!=0){
            layer.msg("请填写第"+falgamount+"个商品的价格！");
            return false;
        }else if(falgquantity.length!=0){
            layer.msg("请填写第"+falgquantity+"个商品的数量！");
            return false;
        }
        /*-----------------------------------------数据验证------------------------------------*/
      layer.confirm("确认提交?",function () {
          $.ajax({
              url: 'inserXsqrsum',
              type:'post',
              dataType:"json",
              contentType: "application/json; charset=utf-8",
              data: JSON.stringify(xsqrjson),
              success:function (res) {
                  layer.msg(res.msg);
              },error:function (res) {
                  layer.msg('网络错误!');
              }
          });
      });
      });
  });

  function GetProdValue(billid,custno,custname,custadd) {
      $("#billidid").val(billid);
      $("#custnoid").val(custno);
      $("#custnameid").val(custname);
      $("#custaddid").val(custadd);
  }


  function adddet() {
      var timestamp = (new Date()).getTime();
      $("#lzul").append(' <li id="'+timestamp+'">\n' +
          '                        <div class="layui-form-item" >\n' +
          '                            <div class="layui-inline">\n' +
          '                                <label class="layui-form-label">商品编码</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                   <span><input type="text" name="prodno" readonly  autocomplete="off" class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <div class="layui-inline" ondblclick="seletprod(this)">\n' +
          '                                <label class="layui-form-label" >商品名称</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                    <span><input type="text" name="prodname" readonly autocomplete="off"  readonly class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <div class="layui-inline">\n' +
          '                                <label class="layui-form-label">规格</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                    <span><input type="text" name="prodspecification" readonly autocomplete="off" class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <div class="layui-inline">\n' +
          '                                <label class="layui-form-label">包装单位</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                    <span><input type="text" name="packageunit"  readonly autocomplete="off" class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <div class="layui-inline">\n' +
          '                                <label class="layui-form-label">生产厂家</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                    <span><input type="text" name="manufacture" readonly  autocomplete="off" class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <div class="layui-inline">\n' +
          '                                <label class="layui-form-label">批准文号</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                    <span><input type="text" name="approvalno" readonly  autocomplete="off" class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <div class="layui-inline">\n' +
          '                                <label class="layui-form-label">灭菌方式</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                    <span><input type="text" name="sterilization"  autocomplete="off" class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <div class="layui-inline">\n' +
          '                                <label class="layui-form-label">数量</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                    <span><input type="text" name="quantity"  autocomplete="off" class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <div class="layui-inline">\n' +
          '                                <label class="layui-form-label">价格</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                    <span><input type="text" name="amount"  autocomplete="off" class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <div class="layui-inline">\n' +
          '                                <label class="layui-form-label">明细备注</label>\n' +
          '                                <div class="layui-input-inline">\n' +
          '                                    <span><input type="text" name="note"  autocomplete="off" class="layui-input"></span>\n' +
          '                                </div>\n' +
          '                            </div>\n' +
          '                            <!--<button class="layui-btn" onclick="deldet(this)">删除</button>-->\n' +
          '                        </div>\n' +
          '                        </li>');

  }
  function deldet(obj) {
      obj.parentNode.parentNode.remove();
  }
</script>

